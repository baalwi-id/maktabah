' ============================================================
' InsertPageMarkers.bas
' Macro Word untuk menyisipkan komentar PAGE:N di paragraf
' pertama setiap halaman baru (termasuk baris tabel).
'
' Cara pakai:
'   1. Buka DOCX di Microsoft Word
'   2. Alt+F11 → Insert → Module → paste macro ini
'   3. Jalankan: Alt+F8 → InsertPageMarkers → Run
'   4. Simpan DOCX → kirim ke parser
' ============================================================

Sub InsertPageMarkers()

    Dim doc As Document
    Dim totalPages As Long
    Dim p As Long
    Dim r As Range
    Dim trackWas As Boolean
    
    Set doc = ActiveDocument
    
    trackWas = doc.TrackRevisions
    doc.TrackRevisions = False
    
    RemoveExistingPageMarkers doc
    
    Application.ScreenUpdating = False
    
    totalPages = doc.ComputeStatistics(wdStatisticPages)
    
    For p = 1 To totalPages
        
        ' Lompat ke awal halaman berdasarkan layout (bukan paragraf)
        Set r = doc.GoTo(What:=wdGoToPage, Which:=wdGoToAbsolute, Count:=p)
        
        ' Cari huruf pertama yang benar-benar terlihat
        MoveToFirstVisibleChar r
        
        If r.Characters.Count > 0 Then
            doc.Comments.Add Range:=r, Text:="PAGE:" & p
        End If
        
    Next p
    
    Application.ScreenUpdating = True
    doc.TrackRevisions = trackWas
    
    MsgBox "Selesai! " & doc.Comments.Count & " komentar PAGE aktif.", _
           vbInformation, "InsertPageMarkers"

End Sub


Sub MoveToFirstVisibleChar(r As Range)

    Dim maxSkip As Long
    Dim ch As String
    
    maxSkip = 400
    
    r.Collapse wdCollapseStart
    r.MoveEnd wdCharacter, 1

    Do While maxSkip > 0
        
        ch = r.Text
        
        If Len(ch) = 1 Then
            Select Case AscW(ch)
                Case 13, 7, 12, 11
                    ' skip formatting characters
                Case Else
                    If Trim(ch) <> "" Then Exit Do
            End Select
        End If
        
        r.MoveStart wdCharacter, 1
        r.MoveEnd wdCharacter, 1
        
        maxSkip = maxSkip - 1
    Loop

End Sub


Sub RemoveExistingPageMarkers(doc As Document)

    Dim i As Long
    
    For i = doc.Comments.Count To 1 Step -1
        If Left(doc.Comments(i).Range.Text, 5) = "PAGE:" Then
            doc.Comments(i).Delete
        End If
    Next i

End Sub